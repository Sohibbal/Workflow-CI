name: Advanced MLOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  mlops:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow[extras]
        pip install scikit-learn pandas numpy matplotlib

    # Clear any cached MLflow data
    - name: Clean MLflow Environment
      run: |
        rm -rf mlruns
        rm -rf MLProject/mlruns

    # ===========================
    # TRAINING MLflow PROJECT
    # ===========================
    - name: Run MLflow Project (Training)
      working-directory: MLProject
      run: |
        echo "ðŸš€ Starting MLflow Project..."
        mlflow run . --env-manager=local 2>&1 | tee mlflow_run.log
        
        echo ""
        echo "ðŸ“‹ Checking for errors in log..."
        if grep -i "error\|exception\|failed" mlflow_run.log; then
          echo "âš ï¸  Potential errors detected in MLflow run"
        else
          echo "âœ… No errors detected"
        fi

    # ===========================
    # COMPREHENSIVE DEBUG
    # ===========================
    - name: Debug - Full Directory Structure
      run: |
        echo "=========================================="
        echo "ðŸ” ROOT DIRECTORY STRUCTURE"
        echo "=========================================="
        ls -la
        
        echo ""
        echo "=========================================="
        echo "ðŸ” FIND ALL mlruns DIRECTORIES"
        echo "=========================================="
        find . -type d -name "mlruns" 2>/dev/null || echo "No mlruns found"
        
        echo ""
        echo "=========================================="
        echo "ðŸ” ROOT mlruns/ (if exists)"
        echo "=========================================="
        if [ -d "mlruns" ]; then
          echo "Found mlruns in root!"
          ls -la mlruns/
          
          if [ -d "mlruns/0" ]; then
            echo ""
            echo "Experiment 0 contents:"
            ls -la mlruns/0/
            
            echo ""
            echo "Looking for run directories (UUID format):"
            find mlruns/0 -maxdepth 1 -type d | grep -E "[a-f0-9]{32}" || echo "No run directories found"
          fi
        else
          echo "No mlruns in root"
        fi
        
        echo ""
        echo "=========================================="
        echo "ðŸ” MLProject/mlruns/ (if exists)"
        echo "=========================================="
        if [ -d "MLProject/mlruns" ]; then
          echo "Found mlruns in MLProject!"
          ls -la MLProject/mlruns/
          
          if [ -d "MLProject/mlruns/0" ]; then
            echo ""
            echo "Experiment 0 contents:"
            ls -la MLProject/mlruns/0/
            
            echo ""
            echo "Looking for run directories (UUID format):"
            find MLProject/mlruns/0 -maxdepth 1 -type d | grep -E "[a-f0-9]{32}" || echo "No run directories found"
            
            echo ""
            echo "All subdirectories in experiment 0:"
            find MLProject/mlruns/0 -maxdepth 1 -type d
          fi
        else
          echo "No mlruns in MLProject"
        fi
        
        echo ""
        echo "=========================================="
        echo "ðŸ” CHECK FOR meta.yaml FILES"
        echo "=========================================="
        find . -name "meta.yaml" -type f 2>/dev/null | head -20


    # GET MODEL_ID
    - name: Get Model ID
      id: get_model_id
      run: |
        MODEL_ID=$(ls mlruns/0/models | head -1)
        echo "model_id=$MODEL_ID" >> $GITHUB_ENV
        echo "Model ID: $MODEL_ID"

    # UPLOAD ARTIFACT MODEL
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-ml-model
        path: mlruns/0/models/${{ env.model_id }}/artifacts

    # ===========================
    # DOCKER SETUP
    # ===========================
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # ===========================
    # BUILD DOCKER IMAGE FROM MODEL
    # ===========================
    - name: Build Docker Image from MLflow Model
      run: |
        mlflow models build-docker \
          -m "mlruns/0/models/${{ env.model_id }}/artifacts" \
          -n "${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest"

    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest

    - name: Completed
      run: echo "ðŸŽ¯ PipelineÂ complete!