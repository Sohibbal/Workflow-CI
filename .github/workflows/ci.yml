name: Advanced MLOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  mlops:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow[extras]
        pip install scikit-learn pandas numpy matplotlib

    # Clear any cached MLflow data
    - name: Clean MLflow Environment
      run: |
        rm -rf mlruns
        rm -rf MLProject/mlruns

    # ===========================
    # TRAINING MLflow PROJECT
    # ===========================
    - name: Run MLflow Project (Training)
      working-directory: MLProject
      run: |
        mlflow run . --env-manager=local

    # ===========================
    # COMPREHENSIVE DEBUG
    # ===========================
    - name: Debug - Full Directory Structure
      run: |
        echo "=========================================="
        echo "üîç ROOT DIRECTORY STRUCTURE"
        echo "=========================================="
        ls -la
        
        echo ""
        echo "=========================================="
        echo "üîç FIND ALL mlruns DIRECTORIES"
        echo "=========================================="
        find . -type d -name "mlruns" 2>/dev/null || echo "No mlruns found"
        
        echo ""
        echo "=========================================="
        echo "üîç ROOT mlruns/ (if exists)"
        echo "=========================================="
        if [ -d "mlruns" ]; then
          echo "Found mlruns in root!"
          ls -la mlruns/
          
          if [ -d "mlruns/0" ]; then
            echo ""
            echo "Experiment 0 contents:"
            ls -la mlruns/0/
            
            echo ""
            echo "Looking for run directories (UUID format):"
            find mlruns/0 -maxdepth 1 -type d | grep -E "[a-f0-9]{32}" || echo "No run directories found"
          fi
        else
          echo "No mlruns in root"
        fi
        
        echo ""
        echo "=========================================="
        echo "üîç MLProject/mlruns/ (if exists)"
        echo "=========================================="
        if [ -d "MLProject/mlruns" ]; then
          echo "Found mlruns in MLProject!"
          ls -la MLProject/mlruns/
          
          if [ -d "MLProject/mlruns/0" ]; then
            echo ""
            echo "Experiment 0 contents:"
            ls -la MLProject/mlruns/0/
            
            echo ""
            echo "Looking for run directories (UUID format):"
            find MLProject/mlruns/0 -maxdepth 1 -type d | grep -E "[a-f0-9]{32}" || echo "No run directories found"
            
            echo ""
            echo "All subdirectories in experiment 0:"
            find MLProject/mlruns/0 -maxdepth 1 -type d
          fi
        else
          echo "No mlruns in MLProject"
        fi
        
        echo ""
        echo "=========================================="
        echo "üîç CHECK FOR meta.yaml FILES"
        echo "=========================================="
        find . -name "meta.yaml" -type f 2>/dev/null | head -20

    # ===========================
    # GET RUN_ID USING PYTHON
    # ===========================
    - name: Get Latest run_id
      id: get_run_id
      run: |
        python << 'PYTHON_SCRIPT'
        import mlflow
        import os
        import sys
        import glob
        from pathlib import Path
        
        # Try to find mlruns directory
        mlruns_paths = ["mlruns", "MLProject/mlruns"]
        mlruns_path = None
        
        for path in mlruns_paths:
            if os.path.exists(os.path.join(path, "0")):
                mlruns_path = path
                break
        
        if mlruns_path is None:
            print("‚ùå No mlruns found!")
            sys.exit(1)
        
        print(f"üìÇ Using mlruns path: {mlruns_path}")
        
        # Method 1: Try MLflow API
        try:
            mlflow.set_tracking_uri(f"file:./{mlruns_path}")
            runs = mlflow.search_runs(
                experiment_ids=["0"], 
                order_by=["start_time desc"], 
                max_results=1
            )
            
            if len(runs) > 0:
                run_id = runs.iloc[0]['run_id']
                print(f"‚úÖ Run ID (from MLflow API): {run_id}")
                
                # Write to GitHub environment
                with open(os.environ['GITHUB_ENV'], 'a') as f:
                    f.write(f"run_id={run_id}\n")
                    f.write(f"mlruns_path={mlruns_path}\n")
                sys.exit(0)
        except Exception as e:
            print(f"‚ö†Ô∏è  MLflow API failed: {e}")
            print("Trying filesystem fallback...")
        
        # Method 2: Fallback - Find run directory from filesystem
        try:
            experiment_path = os.path.join(mlruns_path, "0")
            print(f"üîç Searching in: {experiment_path}")
            
            # Find all directories that look like UUIDs (32 hex chars)
            run_dirs = []
            for item in os.listdir(experiment_path):
                item_path = os.path.join(experiment_path, item)
                if os.path.isdir(item_path) and len(item) == 32:
                    # Check if it's a valid hex string
                    try:
                        int(item, 16)
                        run_dirs.append((item, os.path.getmtime(item_path)))
                    except ValueError:
                        continue
            
            if not run_dirs:
                print("‚ùå No run directories found!")
                print(f"Contents of {experiment_path}:")
                print(os.listdir(experiment_path))
                sys.exit(1)
            
            # Sort by modification time (newest first)
            run_dirs.sort(key=lambda x: x[1], reverse=True)
            run_id = run_dirs[0][0]
            
            print(f"‚úÖ Run ID (from filesystem): {run_id}")
            print(f"‚úÖ MLruns Path: {mlruns_path}")
            
            # Write to GitHub environment
            with open(os.environ['GITHUB_ENV'], 'a') as f:
                f.write(f"run_id={run_id}\n")
                f.write(f"mlruns_path={mlruns_path}\n")
                
        except Exception as e:
            print(f"‚ùå Filesystem fallback failed: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        PYTHON_SCRIPT

    # ===========================
    # VERIFY MODEL EXISTS
    # ===========================
    - name: Verify Model Artifacts
      run: |
        MODEL_PATH="${{ env.mlruns_path }}/0/${{ env.run_id }}/artifacts/model"
        echo "üîç Checking model at: $MODEL_PATH"
        
        if [ ! -d "$MODEL_PATH" ]; then
          echo "‚ùå Model not found at $MODEL_PATH"
          echo ""
          echo "üìã Available artifacts:"
          ARTIFACTS_PATH="${{ env.mlruns_path }}/0/${{ env.run_id }}/artifacts"
          if [ -d "$ARTIFACTS_PATH" ]; then
            ls -la "$ARTIFACTS_PATH"
          else
            echo "No artifacts directory at $ARTIFACTS_PATH"
          fi
          
          echo ""
          echo "üìã Run directory contents:"
          ls -la "${{ env.mlruns_path }}/0/${{ env.run_id }}/"
          exit 1
        fi
        
        echo "‚úÖ Model found!"
        ls -la "$MODEL_PATH"

    # ===========================
    # COPY MODEL TO ROOT FOR DOCKER BUILD
    # ===========================
    - name: Copy Model Artifacts
      run: |
        mkdir -p model_artifacts
        cp -r ${{ env.mlruns_path }}/0/${{ env.run_id }}/artifacts/model/* model_artifacts/
        echo "‚úÖ Model copied to model_artifacts/"
        ls -la model_artifacts/

    # UPLOAD ARTIFACT MODEL
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-ml-model
        path: model_artifacts/

    # ===========================
    # DOCKER SETUP
    # ===========================
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # ===========================
    # BUILD DOCKER IMAGE FROM MODEL
    # ===========================
    - name: Build Docker Image from MLflow Model
      run: |
        mlflow models build-docker \
          -m "model_artifacts" \
          -n "${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest" \
          --enable-mlserver

    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest

    - name: Completed
      run: echo "üéØ Pipeline complete! Docker image pushed successfully!"