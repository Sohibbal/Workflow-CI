name: DagsHub MLOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  train-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12.7"

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow==2.19.0
        pip install scikit-learn pandas numpy dagshub

    # ================================
    # RUN MLProject â†’ modelling.py
    # ================================
    - name: Run MLflow Project
      env:
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        mlflow run MLProject --env-manager=local

    # ===================================
    # GET LATEST RUN ID FROM DAGSHUB
    # ===================================
    - name: Get Latest Run ID
      id: get_run
      env:
        DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        RUN_JSON=$(curl -s -u "${DAGSHUB_USERNAME}:${DAGSHUB_TOKEN}" \
          "https://dagshub.com/api/v1/repos/${DAGSHUB_USERNAME}/obesity-classification/mlflow/runs/search")

        RUN_ID=$(echo "$RUN_JSON" | python3 - <<EOF
        import sys, json data = json.load(sys.stdin) print(data["runs"][0]["info"]["run_id"]) EOF)
        echo "run_id=$RUN_ID" >> $GITHUB_ENV
        echo "Latest RUN ID: $RUN_ID"

    # ===================================
    # DOWNLOAD MODEL ARTIFACT
    # ===================================
    - name: Download Model from DagsHub MLflow
      env:
        DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        mkdir -p model_artifacts
        curl -L -o model.zip -u "${DAGSHUB_USERNAME}:${DAGSHUB_TOKEN}" \
          "https://dagshub.com/${DAGSHUB_USERNAME}/obesity-classification/mlflow-artifacts/${run_id}/artifacts/model/model"

        unzip model.zip -d model_artifacts/

    # Upload model ke GitHub Artifact
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: model_artifacts/

    # ===============================
    # DOCKER BUILD & PUSH
    # ===============================
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Docker Login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Build MLFlow Docker Image
      run: |
        mlflow models build-docker \
          -m model_artifacts \
          -n "${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest"

    - name: Push Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest

    - name: Done
      run: echo "ðŸ”¥ Pipeline selesai!"
