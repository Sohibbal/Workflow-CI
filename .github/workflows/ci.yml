name: Advanced MLOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  mlops:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow[extras]
        pip install scikit-learn pandas numpy matplotlib

    # ===========================
    # TRAINING MLflow PROJECT
    # ===========================
    - name: Run MLflow Project (Training)
      run: |
        mlflow run MLProject --env-manager=local

    # ===========================
    # Debug Struktur Folder MLruns
    # ===========================
    - name: Debug MLflow Folders
      run: |
        echo "ðŸ“‚ Struktur mlruns:"
        ls -R mlruns

    # ===========================
    # Ambil RUN_ID terakhir
    # ===========================
    - name: Get latest MLflow run_id
      id: get_run_id 
      run: |
        # Cari RUN_ID terakhir di dalam folder mlruns
        RUN_ID=$(ls -td MLProject/mlruns/0/*/ | head -n 1 | cut -d'/' -f4)
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Latest run_id: $RUN_ID"

    - name: 6. Upload Artifacts (Model)
      uses: actions/upload-artifact@v4
      with:
        name: ml-model-artifacts
        path: MLProject/mlruns 

    # ===========================
    # UPLOAD ARTIFACT MODEL dari RUN
    # ===========================
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-ml-model
        path: mlruns/0/${{ env.run_id }}/artifacts/model

    # ===========================
    # DOCKER SETUP
    # ===========================
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # ===========================
    # Build Docker Image dari model RUN
    # ===========================
    #  5. Build & Push Docker
    - name: 8. Build Docker Image with MLflow
      run: |
        # Ambil RUN_ID dari langkah 5
        RUN_ID=${{ steps.get_run_id.outputs.run_id }}
        
        # Beritahu MLflow di mana harus mencari 'mlruns'
        export MLFLOW_TRACKING_URI=MLProject/mlruns
        
        echo "Membangun Docker image untuk RUN_ID: $RUN_ID dari $MLFLOW_TRACKING_URI"
        
        # Sekarang sintaks 'runs:/' akan berfungsi
        mlflow models build-docker \
          --model-uri "MLProject/mlruns/0/$RUN_ID/artifacts/model" \
          --name "sohibbal/model-obesity-ci" \
          --env-manager=local

    - name: Push and Tag Docker Image
      run: |
        docker tag "sohibbal/model-obesity-ci" "${{ secrets.DOCKERHUB_USERNAME }}/model-obesity-ci:latest"


    - name: Completed
      run: echo "ðŸŽ¯ Pipeline complete!"
