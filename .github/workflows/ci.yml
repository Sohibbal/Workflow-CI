name: Advanced MLOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  mlops:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow==2.8.1
        pip install scikit-learn pandas numpy dagshub
        pip install matplotlib seaborn

    - name: Install jq
      run: sudo apt-get install -y jq

    # ===========================
    # TRAINING WITH MLflow PROJECT
    # ===========================
    - name: Run MLflow Project (Training)
      env:
        MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        MLFLOW_TRACKING_URI: https://dagshub.com/Sohibbal/obesity-classification.mlflow
      run: |
        mlflow run MLProject --env-manager=local

    # ===========================
    # UPLOAD ARTIFACTS TO GITHUB
    # ===========================
    - name: Upload Feature Importance Artifact
      uses: actions/upload-artifact@v4
      with:
        name: feature-importance
        path: MLProject/feature_importance.csv

    - name: Upload Confusion Matrix Artifact
      uses: actions/upload-artifact@v4
      with:
        name: confusion-matrix
        path: MLProject/confusion_matrix.png

    # ===========================
    # GET LATEST RUN ID FROM DAGSHUB
    # ===========================
    - name: Get Latest Run from DagsHub
      id: get_run
      run: |
        echo "Fetching latest MLflow run from DagsHub..."

        RESPONSE=$(curl -s -u "${{ secrets.DAGSHUB_USERNAME }}:${{ secrets.DAGSHUB_TOKEN }}" \
          "https://dagshub.com/api/v1/repos/Sohibbal/obesity-classification/mlflow/runs/search")

        RUN_ID=$(echo "$RESPONSE" | jq -r '.runs[0].run_id')

        echo "Run ID: $RUN_ID"
        echo "run_id=$RUN_ID" >> $GITHUB_ENV

    # ===========================
    # DOWNLOAD MODEL ARTIFACT FROM DAGSHUB
    # ===========================
    - name: Download Model Artifact
      run: |
        mkdir -p model_artifact
        curl -L -u "${{ secrets.DAGSHUB_USERNAME }}:${{ secrets.DAGSHUB_TOKEN }}" \
          "https://dagshub.com/api/v1/repos/Sohibbal/obesity-classification/mlflow/artifacts/${{ env.run_id }}/model" \
          --output model.zip
        
        unzip model.zip -d model_artifact

    # ===========================
    # DOCKER AUTH + BUILDX
    # ===========================
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # ===========================
    # BUILD DOCKER IMAGE
    # ===========================
    - name: Build Docker Image from MLflow Model
      run: |
        mlflow models build-docker \
          -m "model_artifact/model" \
          -n "${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest"

    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest

    - name: Completed
      run: echo "ðŸŽ¯ Pipeline complete from DagsHub â†’ Docker!"
