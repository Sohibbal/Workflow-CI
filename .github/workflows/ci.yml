name: Advanced MLOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  mlops:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow[extras]
        pip install scikit-learn pandas numpy matplotlib

    # Clear any cached MLflow data
    - name: Clean MLflow Environment
      run: |
        rm -rf mlruns
        rm -rf MLProject/mlruns
        rm -rf mlartifacts
        rm -rf MLProject/mlartifacts

    # ===========================
    # TRAINING MLflow PROJECT
    # ===========================
    - name: Run MLflow Project (Training)
      working-directory: MLProject
      run: |
        echo "ðŸš€ Starting MLflow Project..."
        mlflow run . --env-manager=local 2>&1 | tee mlflow_run.log
        
        echo ""
        echo "ðŸ“‹ Checking for errors in log..."
        if grep -i "error\|exception\|failed" mlflow_run.log; then
          echo "âš ï¸  Potential errors detected in MLflow run"
        else
          echo "âœ… No errors detected"
        fi

    # ===========================
    # COMPREHENSIVE DEBUG
    # ===========================
    - name: Debug - Full Directory Structure
      run: |
        echo "=========================================="
        echo "ðŸ” ROOT DIRECTORY STRUCTURE"
        echo "=========================================="
        ls -la
        
        echo ""
        echo "=========================================="
        echo "ðŸ” FIND ALL mlruns DIRECTORIES"
        echo "=========================================="
        find . -type d -name "mlruns" 2>/dev/null || echo "No mlruns found"
        
        echo ""
        echo "=========================================="
        echo "ðŸ” ROOT mlruns/ (if exists)"
        echo "=========================================="
        if [ -d "mlruns" ]; then
          echo "Found mlruns in root!"
          ls -la mlruns/
          
          if [ -d "mlruns/0" ]; then
            echo ""
            echo "Experiment 0 contents:"
            ls -la mlruns/0/
            
            echo ""
            echo "Looking for run directories (UUID format):"
            find mlruns/0 -maxdepth 1 -type d | grep -E "[a-f0-9]{32}" || echo "No run directories found"
          fi
        else
          echo "No mlruns in root"
        fi
        
        echo ""
        echo "=========================================="
        echo "ðŸ” MLProject/mlruns/ (if exists)"
        echo "=========================================="
        if [ -d "MLProject/mlruns" ]; then
          echo "Found mlruns in MLProject!"
          ls -la MLProject/mlruns/
          
          if [ -d "MLProject/mlruns/0" ]; then
            echo ""
            echo "Experiment 0 contents:"
            ls -la MLProject/mlruns/0/
            
            echo ""
            echo "Looking for run directories (UUID format):"
            find MLProject/mlruns/0 -maxdepth 1 -type d | grep -E "[a-f0-9]{32}" || echo "No run directories found"
            
            echo ""
            echo "All subdirectories in experiment 0:"
            find MLProject/mlruns/0 -maxdepth 1 -type d
          fi
        else
          echo "No mlruns in MLProject"
        fi
        
        echo ""
        echo "=========================================="
        echo "ðŸ” CHECK FOR meta.yaml FILES"
        echo "=========================================="
        find . -name "meta.yaml" -type f 2>/dev/null | head -20

    # ===========================
    # GET RUN_ID USING PYTHON
    # ===========================
    - name: Get Latest run_id and Locate Artifacts
      id: get_run_id
      run: |
        python << 'PYTHON_SCRIPT'
        import mlflow
        import os
        import sys
        import time
        
        # Wait a bit for filesystem to sync
        time.sleep(2)
        
        print("=" * 60)
        print("ðŸ” SEARCHING FOR MLFLOW RUN DATA")
        print("=" * 60)
        
        # Check possible locations for mlruns (metadata) and mlartifacts
        base_paths = ["MLProject", "."]
        mlruns_path = None
        mlartifacts_path = None
        
        # Find mlruns (metadata)
        for base in base_paths:
            path = os.path.join(base, "mlruns")
            if os.path.exists(path):
                mlruns_path = path
                print(f"âœ… Found mlruns at: {mlruns_path}")
                break
        
        # Find mlartifacts (artifacts storage)
        for base in base_paths:
            path = os.path.join(base, "mlartifacts")
            if os.path.exists(path):
                mlartifacts_path = path
                print(f"âœ… Found mlartifacts at: {mlartifacts_path}")
                break
        
        if mlruns_path is None:
            print("âŒ No mlruns directory found!")
            sys.exit(1)
        
        # Set tracking URI
        abs_mlruns_path = os.path.abspath(mlruns_path)
        tracking_uri = f"file://{abs_mlruns_path}"
        mlflow.set_tracking_uri(tracking_uri)
        print(f"ðŸ”— Tracking URI: {tracking_uri}")
        
        try:
            # Get experiment info
            experiment = mlflow.get_experiment_by_name("Default")
            if experiment:
                print(f"\nðŸ“Š Experiment Info:")
                print(f"   ID: {experiment.experiment_id}")
                print(f"   Artifact Location: {experiment.artifact_location}")
            
            # Search for runs
            print("\nðŸ” Searching for runs...")
            runs = mlflow.search_runs(
                experiment_ids=["0"], 
                order_by=["start_time DESC"],
                max_results=5
            )
            
            if len(runs) == 0:
                print("âŒ No runs found!")
                sys.exit(1)
            
            print(f"âœ… Found {len(runs)} runs:\n")
            for idx, row in runs.iterrows():
                run_id = row['run_id']
                run_name = row.get('tags.mlflow.runName', 'N/A')
                status = row.get('status', 'N/A')
                print(f"  {idx+1}. Run ID: {run_id}")
                print(f"     Name: {run_name}")
                print(f"     Status: {status}\n")
            
            # Get the latest run
            latest_run = runs.iloc[0]
            run_id = latest_run['run_id']
            
            print(f"âœ… Selected Run ID: {run_id}")
            
            # Now find where the artifacts actually are
            # Check both possible locations
            artifact_locations = []
            
            # Location 1: mlruns/{exp_id}/{run_id}/artifacts
            loc1 = os.path.join(mlruns_path, "0", run_id, "artifacts")
            if os.path.exists(loc1):
                artifact_locations.append(("mlruns", loc1))
            
            # Location 2: mlartifacts/{exp_id}/{run_id}/artifacts
            if mlartifacts_path:
                loc2 = os.path.join(mlartifacts_path, "0", run_id, "artifacts")
                if os.path.exists(loc2):
                    artifact_locations.append(("mlartifacts", loc2))
            
            if not artifact_locations:
                print("\nâŒ No artifacts found in either location!")
                print(f"   Checked: {loc1}")
                if mlartifacts_path:
                    print(f"   Checked: {loc2}")
                sys.exit(1)
            
            # Use the first location found (should be mlartifacts if it exists)
            storage_type, artifacts_path = artifact_locations[0]
            
            print(f"\nâœ… Artifacts found in: {storage_type}")
            print(f"   Path: {artifacts_path}")
            
            # List artifacts
            if os.path.exists(artifacts_path):
                artifacts = os.listdir(artifacts_path)
                print(f"   Contents: {artifacts}")
                
                # Check for model
                model_path = os.path.join(artifacts_path, "model")
                if os.path.exists(model_path):
                    print(f"   âœ… Model directory exists!")
                    model_files = os.listdir(model_path)
                    print(f"   Model files: {model_files[:5]}...")
                else:
                    print(f"   âŒ Model directory NOT found!")
            
            # Determine the base path for artifacts
            if storage_type == "mlartifacts":
                base_artifacts_path = mlartifacts_path
            else:
                base_artifacts_path = mlruns_path
            
            # Write to GitHub environment
            with open(os.environ['GITHUB_ENV'], 'a') as f:
                f.write(f"run_id={run_id}\n")
                f.write(f"mlruns_path={mlruns_path}\n")
                f.write(f"artifacts_base_path={base_artifacts_path}\n")
                f.write(f"storage_type={storage_type}\n")
            
            print(f"\n{'=' * 60}")
            print("âœ… Environment variables set:")
            print(f"   run_id={run_id}")
            print(f"   artifacts_base_path={base_artifacts_path}")
            print(f"   storage_type={storage_type}")
            print(f"{'=' * 60}")
                
        except Exception as e:
            print(f"âŒ Error: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        PYTHON_SCRIPT

    # ===========================
    # SHOW ARTIFACTS INFO
    # ===========================
    - name: Show Artifacts Info
      run: |
        echo "=========================================="
        echo "ðŸ“¦ Artifacts in Run"
        echo "=========================================="
        echo "Storage Type: ${{ env.storage_type }}"
        echo "Artifacts Base Path: ${{ env.artifacts_base_path }}"
        echo "Run ID: ${{ env.run_id }}"
        
        ARTIFACTS_PATH="${{ env.artifacts_base_path }}/0/${{ env.run_id }}/artifacts"
        
        if [ -d "$ARTIFACTS_PATH" ]; then
          echo "âœ… Artifacts directory found!"
          ls -lah "$ARTIFACTS_PATH"
          
          echo ""
          echo "ðŸ“Š Checking for model directory..."
          if [ -d "$ARTIFACTS_PATH/model" ]; then
            echo "âœ… Model found!"
            ls -lah "$ARTIFACTS_PATH/model"
          else
            echo "âš ï¸  Model directory not found - will fail at Docker build step"
            exit 1
          fi
        else
          echo "âŒ No artifacts directory found at: $ARTIFACTS_PATH"
          exit 1
        fi

    # ===========================
    # UPLOAD ALL ARTIFACTS TO GITHUB
    # ===========================
    - name: Upload Training Artifacts (Confusion Matrix, Datasets, Feature Importance)
      uses: actions/upload-artifact@v4
      with:
        name: training-artifacts
        path: |
          ${{ env.artifacts_base_path }}/0/${{ env.run_id }}/artifacts/*.png
          ${{ env.artifacts_base_path }}/0/${{ env.run_id }}/artifacts/*.csv
        if-no-files-found: warn

    # ===========================
    # COPY MODEL TO ROOT FOR DOCKER BUILD
    # ===========================
    - name: Copy Model Artifacts for Docker Build
      run: |
        MODEL_PATH="${{ env.artifacts_base_path }}/0/${{ env.run_id }}/artifacts/model"
        
        if [ ! -d "$MODEL_PATH" ]; then
          echo "âŒ Model not found at $MODEL_PATH"
          echo "Cannot proceed with Docker build!"
          exit 1
        fi
        
        mkdir -p model_artifacts
        cp -r "$MODEL_PATH"/* model_artifacts/
        echo "âœ… Model copied to model_artifacts/"
        ls -la model_artifacts/

    # UPLOAD MODEL ARTIFACT
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-ml-model
        path: model_artifacts/

    # ===========================
    # DOCKER SETUP
    # ===========================
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # ===========================
    # BUILD DOCKER IMAGE FROM MODEL
    # ===========================
    - name: Build Docker Image from MLflow Model
      run: |
        mlflow models build-docker \
          -m "model_artifacts" \
          -n "${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest" \
          --enable-mlserver

    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest

    - name: Completed
      run: echo "ðŸŽ¯ Pipeline complete! Docker image pushed successfully!"