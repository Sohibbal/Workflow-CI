name: Advanced MLOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  mlops:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.7'

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow[extras]
        pip install scikit-learn pandas numpy matplotlib

    # Clear any cached MLflow data
    - name: Clean MLflow Environment
      run: |
        rm -rf mlruns
        rm -rf MLProject/mlruns

    # ===========================
    # TRAINING MLflow PROJECT
    # ===========================
    - name: Run MLflow Project (Training)
      working-directory: MLProject
      run: |
        mlflow run . --env-manager=local

    # ===========================
    # FIND AND LIST MLRUNS
    # ===========================
    - name: Debug - List MLruns Directory
      run: |
        echo "=== Root mlruns ==="
        ls -la mlruns/ 2>/dev/null || echo "No mlruns in root"
        
        echo "=== MLProject mlruns ==="
        ls -la MLProject/mlruns/ 2>/dev/null || echo "No mlruns in MLProject"
        
        echo "=== Checking experiment folders ==="
        find . -type d -name "mlruns" -exec ls -la {} \;

    # ===========================
    # GET RUN_ID
    # ===========================
    - name: Get Latest run_id
      id: get_run_id
      run: |
        # Try to find mlruns directory (could be in root or MLProject)
        if [ -d "mlruns/0" ]; then
          MLRUNS_PATH="mlruns"
        elif [ -d "MLProject/mlruns/0" ]; then
          MLRUNS_PATH="MLProject/mlruns"
        else
          echo "‚ùå No mlruns found!"
          exit 1
        fi
        
        echo "üìÇ Using mlruns path: $MLRUNS_PATH"
        
        # Get the latest run ID
        RUN_ID=$(ls -td $MLRUNS_PATH/0/*/ 2>/dev/null | head -1 | xargs basename || echo "")
        
        if [ -z "$RUN_ID" ]; then
          echo "‚ùå No run found!"
          exit 1
        fi
        
        echo "run_id=$RUN_ID" >> $GITHUB_ENV
        echo "mlruns_path=$MLRUNS_PATH" >> $GITHUB_ENV
        echo "‚úÖ Run ID: $RUN_ID"
        echo "‚úÖ MLruns Path: $MLRUNS_PATH"

    # ===========================
    # VERIFY MODEL EXISTS
    # ===========================
    - name: Verify Model Artifacts
      run: |
        MODEL_PATH="${{ env.mlruns_path }}/0/${{ env.run_id }}/artifacts/model"
        echo "üîç Checking model at: $MODEL_PATH"
        
        if [ ! -d "$MODEL_PATH" ]; then
          echo "‚ùå Model not found at $MODEL_PATH"
          echo "Available artifacts:"
          ls -la ${{ env.mlruns_path }}/0/${{ env.run_id }}/artifacts/ || echo "No artifacts directory"
          exit 1
        fi
        
        echo "‚úÖ Model found!"
        ls -la $MODEL_PATH

    # ===========================
    # COPY MODEL TO ROOT FOR DOCKER BUILD
    # ===========================
    - name: Copy Model Artifacts
      run: |
        mkdir -p model_artifacts
        cp -r ${{ env.mlruns_path }}/0/${{ env.run_id }}/artifacts/model/* model_artifacts/
        echo "‚úÖ Model copied to model_artifacts/"
        ls -la model_artifacts/

    # UPLOAD ARTIFACT MODEL
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-ml-model
        path: model_artifacts/

    # ===========================
    # DOCKER SETUP
    # ===========================
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # ===========================
    # BUILD DOCKER IMAGE FROM MODEL
    # ===========================
    - name: Build Docker Image from MLflow Model
      run: |
        mlflow models build-docker \
          -m "model_artifacts" \
          -n "${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest" \
          --enable-mlserver

    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/obesity-classification:latest

    - name: Completed
      run: echo "üéØ Pipeline complete! Docker image pushed successfully!"